<%@ page import="java.sql.*" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html>
<head>
    <title>Expense Reports</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .container {
            margin-top: 50px;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .header h2 {
            margin: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>Category-Wise and Monthly Reports</h2>
    </div>
    
    <!-- Filter Form -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-6">
                <label for="category" class="form-label">Category</label>
                <input type="text" name="category" id="category" class="form-control" placeholder="Enter category (optional)">
            </div>
            <div class="col-md-6">
                <label for="month" class="form-label">Month</label>
                <input type="month" name="month" id="month" class="form-control">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <label for="reportType" class="form-label">Report Type</label>
                <select name="reportType" id="reportType" class="form-control">
                    <option value="max">Maximum Expense</option>
                    <option value="min">Minimum Expense</option>
                    <option value="avg">Average Expense</option>
                </select>
            </div>
        </div>
        <div class="mt-3 text-center">
            <button type="submit" class="btn btn-primary">Generate Report</button>
        </div>
    </form>
    
    <!-- Results Table -->
    <table class="table table-hover table-bordered">
        <thead>
            <tr>
                <th>Category</th>
                <th>Month</th>
                <th>Report Type</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <%
                // Get user inputs
                String category = request.getParameter("category");
                String month = request.getParameter("month");
                String reportType = request.getParameter("reportType");

                // Prepare SQL query based on inputs
                String query = "SELECT category, DATE_FORMAT(date, '%Y-%m') AS reportMonth, ";
                if ("max".equalsIgnoreCase(reportType)) {
                    query += "MAX(amount) AS value ";
                } else if ("min".equalsIgnoreCase(reportType)) {
                    query += "MIN(amount) AS value ";
                } else if ("avg".equalsIgnoreCase(reportType)) {
                    query += "AVG(amount) AS value ";
                }
                query += "FROM expenses WHERE 1=1 ";
                if (category != null && !category.trim().isEmpty()) {
                    query += "AND category = ? ";
                }
                if (month != null && !month.trim().isEmpty()) {
                    query += "AND DATE_FORMAT(date, '%Y-%m') = ? ";
                }
                query += "GROUP BY category, DATE_FORMAT(date, '%Y-%m')";

                // Database connection parameters
                String dbURL = "jdbc:mysql://localhost:3306/ expensemanagementsystem ";
                String dbUser = "root";
                String dbPassword = "Root@123";

                try (Connection conn = DriverManager.getConnection(dbURL, dbUser, dbPassword);
                     PreparedStatement pstmt = conn.prepareStatement(query)) {

                    // Set parameters dynamically
                    int paramIndex = 1;
                    if (category != null && !category.trim().isEmpty()) {
                        pstmt.setString(paramIndex++, category);
                    }
                    if (month != null && !month.trim().isEmpty()) {
                        pstmt.setString(paramIndex++, month);
                    }

                    // Execute query and display results
                    ResultSet rs = pstmt.executeQuery();
                    while (rs.next()) {
                        String cat = rs.getString("category");
                        String reportMonth = rs.getString("reportMonth");
                        double value = rs.getDouble("value");
                        %>
                        <tr>
                            <td><%= cat %></td>
                            <td><%= reportMonth %></td>
                            <td><%= reportType %></td>
                            <td><%= value %></td>
                        </tr>
                        <%
                    }
                } catch (SQLException e) {
                    out.println("<tr><td colspan='4' class='text-danger text-center'>Error: " + e.getMessage() + "</td></tr>");
                }
            %>
        </tbody>
    </table>
</div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
