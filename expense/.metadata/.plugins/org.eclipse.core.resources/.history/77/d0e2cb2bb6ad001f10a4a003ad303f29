<%@ page import="java.sql.*" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html>
<head>
    <title>User-Wise Expense Reports</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .container {
            margin-top: 50px;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .header h2 {
            margin: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>User-Wise Expense Reports</h2>
    </div>
    
    <!-- Filter Form -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-6">
                <label for="userId" class="form-label">User ID</label>
                <input type="text" name="userId" id="userId" class="form-control" placeholder="Enter User ID (optional)">
            </div>
            <div class="col-md-6">
                <label for="reportType" class="form-label">Report Type</label>
                <select name="reportType" id="reportType" class="form-control">
                    <option value="max">Maximum Expense</option>
                    <option value="min">Minimum Expense</option>
                    <option value="avg">Average Expense</option>
                </select>
            </div>
        </div>
        <div class="mt-3 text-center">
            <button type="submit" class="btn btn-primary">Generate Report</button>
        </div>
    </form>
    
    <!-- Results Table -->
    <table class="table table-hover table-bordered">
        <thead>
            <tr>
                <th>User ID</th>
                <th>Report Type</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <%
                // Get user inputs
                String userId = request.getParameter("userId");
                String reportType = request.getParameter("reportType");

                // Prepare SQL query based on inputs
                String query = "SELECT user_id, ";
                if ("max".equalsIgnoreCase(reportType)) {
                    query += "MAX(amount) AS value ";
                } else if ("min".equalsIgnoreCase(reportType)) {
                    query += "MIN(amount) AS value ";
                } else if ("avg".equalsIgnoreCase(reportType)) {
                    query += "AVG(amount) AS value ";
                }
                query += "FROM expenses WHERE 1=1 ";
                if (userId != null && !userId.trim().isEmpty()) {
                    query += "AND user_id = ? ";
                }
                query += "GROUP BY user_id";

                // Database connection parameters
                String dbURL = "jdbc:mysql://localhost:3306/expensemanagementsystem";
                String dbUser = "root";
                String dbPassword = "Root@123";

                try (Connection conn = DriverManager.getConnection(dbURL, dbUser, dbPassword);
                     PreparedStatement pstmt = conn.prepareStatement(query)) {

                    // Set parameters dynamically
                    if (userId != null && !userId.trim().isEmpty()) {
                        pstmt.setInt(1, Integer.parseInt(userId));
                    }

                    // Execute query and display results
                    ResultSet rs = pstmt.executeQuery();
                    while (rs.next()) {
                        int user = rs.getInt("user_id");
                        double value = rs.getDouble("value");
                        %>
                        <tr>
                            <td><%= user %></td>
                            <td><%= reportType %></td>
                            <td><%= value %></td>
                        </tr>
                        <%
                    }
                } catch (SQLException e) {
                    out.println("<tr><td colspan='3' class='text-danger text-center'>Error: " + e.getMessage() + "</td></tr>");
                }
            %>
        </tbody>
    </table>
</div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
